pipeline {
    agent {
        docker {
            image 'mcr.microsoft.com/dotnet/sdk:6.0' // Usa una imagen oficial de .NET SDK
            args '-u root:root' // Permite instalar o escribir si hace falta
        }
    }

    environment {
        DOTNET_CLI_TELEMETRY_OPTOUT = '1'
        DOTNET_SKIP_FIRST_TIME_EXPERIENCE = '1'
    }

    options {
        timestamps()
    }

    stages {
        stage('Checkout') {
            steps {
                echo 'Clonando el repositorio...'
                checkout scm
            }
        }

        stage('Restaurar dependencias') {
            steps {
                echo 'Restaurando dependencias con dotnet restore...'
                sh 'dotnet restore'
            }
        }

        stage('Compilar') {
            steps {
                echo 'Compilando solución...'
                sh 'dotnet build --configuration Release --no-restore'
            }
        }

        stage('Ejecutar Tests') {
            steps {
                echo 'Ejecutando pruebas NUnit...'
                sh 'dotnet test --configuration Release --no-build --logger "trx;LogFileName=test_results.trx" --results-directory TestResults'
            }
        }

        stage('Publicar resultados de test') {
            steps {
                echo 'Publicando resultados de test en formato JUnit (desde TRX)...'
                junit 'TestResults/test_results.trx'
            }
        }
    }

    post {
        success {
            echo 'Pipeline finalizada con éxito.'
        }

        failure {
            echo 'La compilación o pruebas fallaron.'
        }
    }
}
